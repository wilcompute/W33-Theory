$ErrorActionPreference = "Stop"

$root = Split-Path -Parent $PSScriptRoot
$dataDir = Join-Path $root "data"
$outPath = Join-Path $dataDir "_docs/toe_atlas.md"
$bt = [char]96

function To-RelPath([string]$fullPath) {
    $prefix = $dataDir + "\"
    if ($fullPath.StartsWith($prefix, [System.StringComparison]::OrdinalIgnoreCase)) {
        $rel = "data/" + $fullPath.Substring($prefix.Length)
        return $rel -replace "\\", "/"
    }
    return $fullPath -replace "\\", "/"
}

$bucketOrder = @(
    "_docs",
    "_toe",
    "_workbench",
    "_is",
    "_pg32",
    "_checkpoints",
    "_embeddings",
    "_tomotope",
    "_n12",
    "_w33",
    "_witting",
    "_algebra",
    "_sources",
    "_variants",
    "_archives",
    "_user"
)

$timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss 'UTC'")
$lines = @(
    "# TOE atlas",
    "",
    "Generated by ${bt}scripts/toe_atlas.ps1${bt} on $timestamp.",
    "",
    "This lists CSV/JSON files per bucket (root + per-collection).",
    ""
)

foreach ($bucket in $bucketOrder) {
    $bucketPath = Join-Path $dataDir $bucket
    if (-not (Test-Path $bucketPath)) { continue }

    $lines += "## $bucket"

    $rootFiles = Get-ChildItem -Path $bucketPath -File | Where-Object {
        $_.Extension -in @(".csv", ".json")
    } | Sort-Object Name

    $subdirs = Get-ChildItem -Path $bucketPath -Directory | Sort-Object Name

    $lines += "- collections: $($subdirs.Count)"
    $lines += "- root_csv_json: $($rootFiles.Count)"

    if ($rootFiles.Count -gt 0) {
        $lines += ""
        $lines += "### $bucket (root)"
        foreach ($file in $rootFiles) {
            $lines += "- ${bt}$(To-RelPath $file.FullName)${bt}"
        }
    }

    foreach ($dir in $subdirs) {
        $files = Get-ChildItem -Path $dir.FullName -File | Where-Object {
            $_.Extension -in @(".csv", ".json")
        } | Sort-Object Name

        $lines += ""
        $lines += "### $bucket/$($dir.Name)"
        $lines += "- csv_json: $($files.Count)"
        if ($files.Count -eq 0) {
            $lines += "- (none)"
            continue
        }
        foreach ($file in $files) {
            $lines += "- ${bt}$(To-RelPath $file.FullName)${bt}"
        }
    }

    $lines += ""
}

$lines -join "`n" | Set-Content -Path $outPath -Encoding UTF8
Write-Output "Wrote $outPath"
