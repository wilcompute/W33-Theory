name: sage-verification

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  sage-verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Make helper scripts executable
      run: |
        chmod +x claude_workspace/run_sage.sh || true
        chmod +x scripts/run_all_sage.sh || true

    - name: Run all Sage verification scripts in Docker
      run: docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "bash claude_workspace/run_sage.sh"

    - name: Collect PART_*.json results (Sage)
      run: |
        docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "bash claude_workspace/run_sage.sh claude_workspace/scripts/collect_results.py"

    - name: Extract numeric comparisons
      run: |
        docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "bash claude_workspace/run_sage.sh claude_workspace/scripts/make_numeric_comparisons_from_summary.py"

    - name: Upload PART_*.json artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sage-part-jsons
        path: PART_*.json
        if-no-files-found: warn

    - name: Download PART_*.json artifacts (for collection)
      uses: actions/download-artifact@v4
      with:
        name: sage-part-jsons
        path: artifacts/sage-part-jsons

    - name: Collect SUMMARY_RESULTS and run extractor
      run: |
        python scripts/collect_results_from_artifact.py artifacts/sage-part-jsons || true

    - name: Upload SUMMARY_RESULTS.json
      uses: actions/upload-artifact@v4
      with:
        name: summary-results
        path: SUMMARY_RESULTS.json
        if-no-files-found: warn

    - name: Upload NUMERIC_COMPARISONS.json
      uses: actions/upload-artifact@v4
      with:
        name: numeric-comparisons
        path: NUMERIC_COMPARISONS.json
        if-no-files-found: warn
