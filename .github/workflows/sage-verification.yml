name: sage-verification

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, synchronize, reopened]


jobs:
  sage-verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Make helper scripts executable
      run: |
        chmod +x run_sage.sh || true
        chmod +x scripts/run_all_sage.sh || true
        chmod +x scripts/setup_sage_pysymmetry_docker.sh || true

    - name: Run all Sage verification scripts in Docker
      run: docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "bash scripts/run_all_sage.sh"

    - name: Ensure PySymmetry (Docker)
      run: |
        if [ ! -d external/pysymmetry/.git ]; then
          git clone https://github.com/ldsufrpe/pysymmetry external/pysymmetry
        fi

    - name: Run PySymmetry reductions (Docker)
      continue-on-error: true
      run: |
        docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "./run_sage.sh lib/scripts/scripts/pysymmetry_deck_z2_reduction.py"
        docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "./run_sage.sh lib/scripts/scripts/pysymmetry_2t_clock_reduction.py"
        docker run --rm -v "${{ github.workspace }}:/work" -w /work sagemath/sagemath:10.7 bash -lc "./run_sage.sh lib/scripts/scripts/pysymmetry_d6_incidence_reduction.py"

    - name: Upload PySymmetry outputs
      uses: actions/upload-artifact@v4
      with:
        name: pysymmetry-outputs
        path: |
          data/_workbench/05_symmetry/pysymmetry_*.md
          data/_workbench/05_symmetry/pysymmetry_*.csv
        if-no-files-found: warn

    - name: Extract numeric comparisons
      run: |
        python scripts/make_numeric_comparisons_from_summary.py || true

    - name: Upload PART_*.json artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sage-part-jsons
        path: PART_*.json
        if-no-files-found: warn

    - name: Download PART_*.json artifacts (for collection)
      uses: actions/download-artifact@v4
      with:
        name: sage-part-jsons
        path: artifacts/sage-part-jsons

    - name: Collect SUMMARY_RESULTS and run extractor
      run: |
        python scripts/collect_results_from_artifact.py artifacts/sage-part-jsons || true

    - name: List generated files
      run: |
        echo "Listing generated files:"
        ls -la SUMMARY_RESULTS.json || true
        ls -la NUMERIC_COMPARISONS.json || true
        echo "\nSUMMARY_RESULTS.json preview:"
        head -n 60 SUMMARY_RESULTS.json || true
        echo "\nNUMERIC_COMPARISONS.json preview:"
        head -n 60 NUMERIC_COMPARISONS.json || true

    - name: Run artifact tests (pytest)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip pytest jsonschema

    - name: Run artifact validation tests
      run: |
        pytest -q tests/test_summary.py::test_summary_and_numeric_comparisons tests/test_summary_schema.py::test_summary_matches_schema tests/test_summary_schema.py::test_numeric_comparisons_matches_schema

    - name: Upload SUMMARY_RESULTS.json
      uses: actions/upload-artifact@v4
      with:
        name: summary-results
        path: SUMMARY_RESULTS.json
        if-no-files-found: warn

    - name: Upload NUMERIC_COMPARISONS.json
      uses: actions/upload-artifact@v4
      with:
        name: numeric-comparisons
        path: NUMERIC_COMPARISONS.json
        if-no-files-found: warn
