name: Predictions report

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  predictions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install test deps
        run: python -m pip install --upgrade pip pytest

      - name: Run prediction tests (allow failures to collect report)
        run: python -m pytest tests/test_predictions.py -q
        continue-on-error: true

      - name: Generate predictions report
        run: python tools/generate_predictions_report.py

      - name: Upload predictions report artifact
        uses: actions/upload-artifact@v4
        with:
          name: predictions-report
          path: |
            artifacts/predictions_report.json
            artifacts/predictions_report.md

      - name: Regenerate verification digest
        run: python tools/build_verification_digest.py || true

      - name: Commit predictions report to `predictions/latest` branch
        uses: actions/checkout@v4
        with:
          persist-credentials: true
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # create or checkout the branch predictions/latest
          if git ls-remote --heads origin predictions/latest; then
            git fetch origin predictions/latest:predictions/latest
            git checkout predictions/latest
          else
            git checkout -b predictions/latest
          fi
          mkdir -p artifacts
          cp artifacts/predictions_report.md artifacts/predictions_report.md
          cp artifacts/verification_digest.md artifacts/verification_digest.md || true
          git add artifacts/predictions_report.md artifacts/verification_digest.md || true
          git commit -m "chore: update predictions report and verification digest" || true
          git push origin predictions/latest --force

      - name: Post PR comment with summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('artifacts/predictions_report.json', 'utf8'));
            let summary = `### Predictions check — ${report.summary.passed}/${report.summary.total} passed\n\n`;
            summary += '| Key | Pred | Ref | Diff | Allowed | Result |\n|---|---:|---:|---:|---:|---:|\n';
            for (const k of Object.keys(report.items)) {
              const item = report.items[k];
              summary += `| ${k} | ${item.pred} | ${item.ref} | ${item.diff} | ${item.allowed} | ${item.pass ? '✅' : '❌'} |\n`;
            }
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
