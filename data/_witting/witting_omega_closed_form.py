"""
Closed-form Ω for Witting configuration using a PG(3,3) coordinatization.

Inputs are (rank,suit) pairs where rank∈{0..9} and suit∈{0..3}.
Output Ω_mod3 ∈ {0,1,2} on complement triangles (no orth edges), else None.
Map to Ω_z6 via {0:3,1:1,2:5}.
"""

import itertools

# rank_suit_table_to_ray_index (10x4)
T = [
    [0, 1, 2, 3],
    [4, 5, 6, 7],
    [8, 25, 26, 23],
    [28, 9, 22, 19],
    [20, 21, 10, 11],
    [12, 33, 34, 39],
    [16, 13, 38, 31],
    [36, 37, 14, 15],
    [32, 17, 30, 35],
    [24, 29, 18, 27],
]

# PG(3,3) coordinates for each ray index 0..39
COORD = [
    (0, 0, 0, 1),
    (1, 0, 0, 1),
    (1, 0, 0, 0),
    (1, 0, 0, 2),
    (0, 1, 0, 1),
    (1, 2, 2, 1),
    (1, 0, 2, 2),
    (1, 1, 2, 0),
    (1, 1, 0, 0),
    (1, 1, 1, 0),
    (0, 0, 1, 0),
    (1, 2, 1, 0),
    (1, 2, 0, 1),
    (0, 1, 1, 1),
    (1, 0, 1, 2),
    (0, 1, 2, 0),
    (1, 1, 0, 1),
    (0, 1, 1, 2),
    (1, 0, 1, 0),
    (0, 1, 2, 2),
    (1, 2, 0, 0),
    (1, 2, 2, 0),
    (1, 0, 2, 1),
    (1, 1, 2, 2),
    (0, 1, 0, 2),
    (1, 1, 1, 1),
    (0, 0, 1, 1),
    (1, 2, 1, 1),
    (1, 2, 0, 2),
    (1, 1, 1, 2),
    (0, 0, 1, 2),
    (1, 2, 1, 2),
    (0, 1, 0, 0),
    (0, 1, 1, 0),
    (1, 0, 1, 1),
    (0, 1, 2, 1),
    (1, 1, 0, 2),
    (1, 2, 2, 2),
    (1, 0, 2, 0),
    (1, 1, 2, 1),
]

# Symplectic form J0 over F3
J0 = [[0, 1, 0, 0], [2, 0, 0, 0], [0, 0, 0, 1], [0, 0, 2, 0]]

# Orth pairs (undirected) as a set of sorted tuples
ORTH = [
    (0, 1),
    (0, 2),
    (0, 3),
    (0, 4),
    (0, 8),
    (0, 12),
    (0, 16),
    (0, 20),
    (0, 24),
    (0, 28),
    (0, 32),
    (0, 36),
    (1, 2),
    (1, 3),
    (1, 5),
    (1, 9),
    (1, 13),
    (1, 17),
    (1, 21),
    (1, 25),
    (1, 29),
    (1, 33),
    (1, 37),
    (2, 3),
    (2, 6),
    (2, 10),
    (2, 14),
    (2, 18),
    (2, 22),
    (2, 26),
    (2, 30),
    (2, 34),
    (2, 38),
    (3, 7),
    (3, 11),
    (3, 15),
    (3, 19),
    (3, 23),
    (3, 27),
    (3, 31),
    (3, 35),
    (3, 39),
    (4, 5),
    (4, 6),
    (4, 7),
    (4, 21),
    (4, 22),
    (4, 23),
    (4, 24),
    (4, 32),
    (4, 37),
    (4, 38),
    (4, 39),
    (5, 6),
    (5, 7),
    (5, 18),
    (5, 19),
    (5, 20),
    (5, 25),
    (5, 30),
    (5, 31),
    (5, 33),
    (5, 36),
    (6, 7),
    (6, 11),
    (6, 15),
    (6, 16),
    (6, 17),
    (6, 26),
    (6, 28),
    (6, 29),
    (6, 34),
    (7, 8),
    (7, 9),
    (7, 10),
    (7, 12),
    (7, 13),
    (7, 14),
    (7, 27),
    (7, 35),
    (8, 9),
    (8, 10),
    (8, 16),
    (8, 23),
    (8, 25),
    (8, 26),
    (8, 29),
    (8, 30),
    (8, 36),
    (8, 39),
    (9, 10),
    (9, 17),
    (9, 19),
    (9, 22),
    (9, 24),
    (9, 28),
    (9, 31),
    (9, 34),
    (9, 37),
    (10, 11),
    (10, 15),
    (10, 18),
    (10, 20),
    (10, 21),
    (10, 32),
    (10, 33),
    (10, 38),
    (11, 14),
    (11, 16),
    (11, 17),
    (11, 19),
    (11, 20),
    (11, 21),
    (11, 24),
    (11, 25),
    (11, 39),
    (12, 13),
    (12, 14),
    (12, 17),
    (12, 18),
    (12, 20),
    (12, 23),
    (12, 28),
    (12, 33),
    (12, 34),
    (12, 39),
    (13, 14),
    (13, 16),
    (13, 19),
    (13, 21),
    (13, 26),
    (13, 29),
    (13, 31),
    (13, 32),
    (13, 38),
    (14, 15),
    (14, 22),
    (14, 24),
    (14, 25),
    (14, 30),
    (14, 36),
    (14, 37),
    (15, 23),
    (15, 28),
    (15, 29),
    (15, 31),
    (15, 32),
    (15, 33),
    (15, 36),
    (15, 37),
    (16, 17),
    (16, 22),
    (16, 27),
    (16, 31),
    (16, 33),
    (16, 36),
    (16, 38),
    (17, 18),
    (17, 23),
    (17, 30),
    (17, 32),
    (17, 35),
    (17, 37),
    (18, 19),
    (18, 23),
    (18, 24),
    (18, 27),
    (18, 29),
    (18, 36),
    (18, 38),
    (19, 22),
    (19, 26),
    (19, 28),
    (19, 32),
    (19, 36),
    (19, 39),
    (20, 21),
    (20, 26),
    (20, 27),
    (20, 28),
    (20, 30),
    (20, 31),
    (20, 37),
    (21, 22),
    (21, 23),
    (21, 29),
    (21, 34),
    (21, 35),
    (21, 36),
    (22, 23),
    (22, 27),
    (22, 28),
    (22, 30),
    (22, 33),
    (23, 25),
    (23, 26),
    (23, 31),
    (24, 25),
    (24, 27),
    (24, 29),
    (24, 31),
    (24, 32),
    (24, 34),
    (25, 26),
    (25, 28),
    (25, 33),
    (25, 35),
    (25, 38),
    (26, 27),
    (26, 32),
    (26, 34),
    (26, 37),
    (27, 29),
    (27, 33),
    (27, 35),
    (27, 37),
    (28, 29),
    (28, 35),
    (28, 38),
    (29, 30),
    (29, 39),
    (30, 31),
    (30, 32),
    (30, 35),
    (30, 39),
    (31, 34),
    (31, 38),
    (32, 33),
    (32, 35),
    (33, 34),
    (33, 39),
    (34, 35),
    (34, 36),
    (34, 39),
    (35, 36),
    (35, 38),
    (36, 37),
    (37, 38),
    (37, 39),
    (38, 39),
]


def _bilinear(u, v):
    # u,v are 4-tuples in F3
    val = 0
    for i in range(4):
        for j in range(4):
            val += u[i] * J0[i][j] * v[j]
    return val % 3


def _is_collinear(u, v, w):
    # w in span(u,v) over F3?
    for a in (0, 1, 2):
        for b in (0, 1, 2):
            if a == 0 and b == 0:
                continue
            if tuple(((a * u[i] + b * v[i]) % 3) for i in range(4)) == tuple(
                (w[i] % 3) for i in range(4)
            ):
                return True
    return False


def omega_mod3(tri):
    """tri = [(r,s),(r,s),(r,s)]. Returns 0/1/2, or None if any edge is orth."""
    pts = [T[r][s] for (r, s) in tri]
    for i, j in itertools.combinations(pts, 2):
        a, b = sorted((i, j))
        if (a, b) in ORTH:
            return None
    u, v, w = [COORD[p] for p in pts]
    if _is_collinear(u, v, w) or _is_collinear(v, w, u) or _is_collinear(w, u, v):
        return 0
    return (_bilinear(u, v) * _bilinear(v, w) * _bilinear(w, u)) % 3


def omega_z6(tri):
    om = omega_mod3(tri)
    if om is None:
        return None
    return {0: 3, 1: 1, 2: 5}[om]
