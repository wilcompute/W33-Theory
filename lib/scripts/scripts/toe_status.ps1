$ErrorActionPreference = "Stop"

$root = Split-Path -Parent $PSScriptRoot

function Load-Json([string]$relativePath) {
    $path = Join-Path $root $relativePath
    if (Test-Path $path) {
        return Get-Content -Path $path -Raw | ConvertFrom-Json
    }
    return $null
}

function To-CompactJson($obj) {
    if ($null -eq $obj) { return "" }
    return ($obj | ConvertTo-Json -Compress -Depth 6)
}

function To-List([object[]]$items) {
    if ($null -eq $items) { return "" }
    return ($items | ForEach-Object { $_.ToString() }) -join ", "
}

function Section([string]$title, [string[]]$lines) {
    return @("## $title") + $lines + @("")
}

$lines = @(
    "# TOE status (derived from checkpoint JSONs)",
    "",
    "This file is generated by `scripts/toe_status.ps1` from JSON checkpoints only.",
    ""
)

# 1) Incidence autgroup
$aut = Load-Json "data/_is/incidence_autgroup_20260110/checkpoint_autgroup_20260110.json"
if ($aut) {
    $key = $aut.key_results
    $lines += Section "Incidence autgroup (12 points / 15 lines)" @(
        "- aut_group_order: $($key.aut_group_order)",
        "- distinguished_point: $($key.distinguished_point)",
        "- generator_names: $(To-List $key.generator_names)",
        "- degree_spectrum: $(To-CompactJson $key.degree_spectrum)"
    )
}

# 2) Tomotope best-fit to projective classes
$bestfit = Load-Json "data/_checkpoints/checkpoint_tomotope_to_n12_58_projective_bestfit_20260110t043900z.json"
if ($bestfit) {
    $opt = $bestfit.optimization
    $lines += Section "Tomotope to projective best-fit" @(
        "- best_score: $($opt.best_score)",
        "- matched_triangles: $($opt.matched_triangles)",
        "- unmatched_triangles: $(To-List $opt.unmatched_triangles)",
        "- key_hits: $(To-CompactJson $opt.key_hits)"
    )
}

# 3) Triangle to W33 completion
$completion = Load-Json "data/_checkpoints/checkpoint_tomotope_triangle_to_w33_completion_20260110t043900z.json"
if ($completion) {
    $notes = $completion.notes
    $lines += Section "Tomotope triangle -> W33 completion" @(
        "- matched_triangles: $($notes.matched_triangles)",
        "- unmatched_triangle: $($notes.unmatched_triangle)",
        "- key_wedge_lines: $(To-CompactJson $notes.key_wedge_lines)"
    )
}

# 4) Toe coupling
$coupling = Load-Json "data/_toe/coupling_20260110/checkpoint_toe_coupling_20260110.json"
if ($coupling) {
    $notes = $coupling.notes
    $lines += Section "TOE coupling (2T transport)" @(
        "- delta4_edges: $(To-List $notes.delta4_edges)",
        "- unique_edge_elems: $(To-List $notes.unique_edge_elems)"
    )
}

# 5) Flux toggle node0 (checkpoint only)
$toggle = Load-Json "data/_toe/flux_toggle_node0_20260110/checkpoint_toe_flux_toggle_node0_20260110.json"
if ($toggle) {
    $files = $toggle.files.PSObject.Properties.Name | Sort-Object
    $lines += Section "Flux toggle (node0) artifacts" @(
        "- file_count: $($files.Count)",
        "- files: $(To-List $files)"
    )
}

# 6) Take it all the way
$take = Load-Json "data/_toe/take_it_all_way_20260110/checkpoint_toe_take_it_all_way_20260110.json"
if ($take) {
    $files = $take.files.PSObject.Properties.Name | Sort-Object
    $lines += Section "Take it all the way (D6/D8 closure)" @(
        "- file_count: $($files.Count)",
        "- files: $(To-List $files)"
    )
}

# 7) W33 orthonormal solution report
$orth = Load-Json "data/_toe/w33_orthonormal_phase_solution_20260110/W33_orthonormal_solution_report.json"
if ($orth) {
    $lines += Section "W33 orthonormal solution report" @(
        "- max_line_orthonormality_error: $($orth.max_line_orthonormality_error)",
        "- nonorth_absip2_min: $($orth.nonorth_absip2_min)",
        "- nonorth_absip2_max: $($orth.nonorth_absip2_max)",
        "- counts: $(To-CompactJson $orth.counts)"
    )
}

# 8) Orbit-0 cocycle summary
$cocycle = Load-Json "data/_toe/geometric_reduction_20260110/orbit0_cocycle_summary.json"
if ($cocycle) {
    $lines += Section "Orbit-0 cocycle summary" @(
        "- n_nodes: $($cocycle.n_nodes)",
        "- n_edges: $($cocycle.n_edges)",
        "- n_defect_edges: $($cocycle.n_defect_edges)",
        "- cycle_space_dim: $($cocycle.cycle_space_dim)",
        "- n_chords_with_odd_parity: $($cocycle.n_chords_with_odd_parity)"
    )
}

# 9) Harmonic lift checkpoint (file manifest)
$harm = Load-Json "data/_toe/harmonic_lift_geometry_predictor_20260110/checkpoint_harmonic_lift_geometry_predictor.json"
if ($harm) {
    $files = $harm.files.PSObject.Properties.Name | Sort-Object
    $lines += Section "Harmonic lift geometry predictor (files)" @(
        "- file_count: $($files.Count)",
        "- files: $(To-List $files)"
    )
}

# 10) Domain-wall sensors summary
$domain = Load-Json "data/_toe/domainwall_to_w33_sensors_20260110/summary.json"
if ($domain) {
    $lines += Section "Domain-wall to W33 sensors" @(
        "- mincut_nondefect_cost: $($domain.mincut_nondefect_cost)",
        "- top10_lines: $(To-List $domain.top10_lines)",
        "- top10_low_class_hits: $($domain.top10_low_class_hits)",
        "- top10_mid_class_hits: $($domain.top10_mid_class_hits)"
    )
}

# 11) Native C24 projectors
$native = Load-Json "data/_toe/native_w33_projectors_c24_20260110/checkpoint_native_C24_projectors_20260110.json"
if ($native) {
    $lines += Section "Native C24 projectors" @(
        "- uvec_definition: $($native.uvec_definition)",
        "- param_points: $(To-List $native.param_points)",
        "- created_files_count: $($native.created_files.Count)"
    )
}

# 12) Native C24 full-grid
$nativeFull = Load-Json "data/_toe/native_fullgrid_20260110/checkpoint_nativeC24_fullgrid_20260110.json"
if ($nativeFull) {
    $notes = $nativeFull.notes
    $grid = $nativeFull.grid
    $lines += Section "Native C24 full-grid" @(
        "- winner_changed_count: $($notes.winner_changed_count)",
        "- lambda_min: $($grid.lambda_min)",
        "- lambda_max: $($grid.lambda_max)",
        "- lambda_step: $($grid.lambda_step)",
        "- mu: $(To-List $grid.mu)"
    )
}

$outPath = Join-Path $root "data/_docs/toe_status.md"
$lines -join "`n" | Set-Content -Path $outPath -Encoding utf8
Write-Output "Wrote $outPath"

