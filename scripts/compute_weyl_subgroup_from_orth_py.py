#!/usr/bin/env python3
"""Compute group generated by reflections in the orthogonal complement roots (72 roots) and report its order and orbits using sympy."""
import json
from fractions import Fraction
from pathlib import Path
import itertools

try:
    from sympy.combinatorics.perm_groups import PermutationGroup
    from sympy.combinatorics.permutations import Permutation
except Exception as e:
    print('sympy not available:', e)
    raise

data = json.loads(Path('PART_CVII_e6_via_A2.json').read_text())
orth = data[0]['orth_indices']
print('orth size', len(orth))

# build E8 roots rational
E8 = []
for i in range(8):
    for j in range(i+1, 8):
        for si in (-1,1):
            for sj in (-1,1):
                r = [0]*8
                r[i] = si
                r[j] = sj
                E8.append(tuple(Fraction(x) for x in r))
for signs in itertools.product([-1,1], repeat=8):
    if sum(1 for s in signs if s<0) % 2 == 0:
        r = tuple(Fraction(s,2) for s in signs)
        E8.append(r)
assert len(E8) == 240

orth_vectors = [E8[i] for i in orth]
vec_to_idx = {v:i for i,v in enumerate(orth_vectors)}

# dot
def dot(u,v):
    return sum(ui*vi for ui,vi in zip(u,v))

perms = []
for alpha in orth_vectors:
    perm = []
    denom = dot(alpha, alpha)
    for v in orth_vectors:
        w = tuple((vv - 2*dot(v,alpha)/denom * aa) for vv,aa in zip(v, alpha))
        if w not in vec_to_idx:
            print('Reflection maps outside orth set!')
            break
        perm.append(vec_to_idx[w])
    else:
        perms.append(Permutation(perm))

print('Built', len(perms), 'permutations')
PG = PermutationGroup(perms)
order = PG.order()
orbits = PG.orbits()
print('group order', order)
print('orbit sizes', [len(o) for o in orbits])

out = {'weyl_subgroup_order': int(order), 'orbit_sizes': [len(o) for o in orbits]}
Path('PART_CVII_e6_weyl_subgroup_py.json').write_text(json.dumps(out, indent=2))
print('Wrote PART_CVII_e6_weyl_subgroup_py.json')
