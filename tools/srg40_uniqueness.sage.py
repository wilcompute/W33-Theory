#!/usr/bin/env sage
"""
Enumerate SRG(40,12,2,4) graphs from Sage's database and compare invariants
against the symplectic polar graph W33.

Outputs:
- artifacts/srg40_uniqueness.json
- artifacts/srg40_uniqueness.md
"""

# This file was *autogenerated* from the file tools/srg40_uniqueness.sage
from sage.all_cmdline import *  # import sage library

_sage_const_0 = Integer(0)
_sage_const_4 = Integer(4)
_sage_const_3 = Integer(3)
_sage_const_40 = Integer(40)
_sage_const_12 = Integer(12)
_sage_const_2 = Integer(2)
import json
from datetime import datetime

from sage.all import *

out_json = "artifacts/srg40_uniqueness.json"
out_md = "artifacts/srg40_uniqueness.md"

results = {
    "timestamp": datetime.now().isoformat(),
    "graphs": [],
    "count": _sage_const_0,
    "errors": [],
}

W33 = graphs.SymplecticPolarGraph(_sage_const_4, _sage_const_3)

try:
    from sage.graphs.strongly_regular_db import strongly_regular_graphs

    graphs_iter = strongly_regular_graphs(
        _sage_const_40, _sage_const_12, _sage_const_2, _sage_const_4
    )
except Exception as e:
    results["errors"].append(f"Failed to import strongly_regular_graphs: {e}")
    graphs_iter = []

for idx, G in enumerate(graphs_iter):
    try:
        aut = G.automorphism_group().order()
    except Exception:
        aut = None

    try:
        clique_num = G.clique_number()
        clique_max_count = len(G.cliques_maximum()) if clique_num is not None else None
    except Exception:
        clique_num = None
        clique_max_count = None

    # neighbor-graph triangle-free property
    neighbor_triangle_free = True
    try:
        for v in G.vertices():
            N = G.subgraph(G.neighbors(v))
            if N.triangles_count() != _sage_const_0:
                neighbor_triangle_free = False
                break
    except Exception:
        neighbor_triangle_free = None

    try:
        is_w33 = G.is_isomorphic(W33)
    except Exception:
        is_w33 = None

    results["graphs"].append(
        {
            "index": idx,
            "aut_order": int(aut) if aut is not None else None,
            "clique_number": int(clique_num) if clique_num is not None else None,
            "max_clique_count": (
                int(clique_max_count) if clique_max_count is not None else None
            ),
            "neighbor_graphs_triangle_free": neighbor_triangle_free,
            "isomorphic_to_w33": is_w33,
        }
    )

results["count"] = len(results["graphs"])

# Write JSON
import os

os.makedirs("artifacts", exist_ok=True)
with open(out_json, "w") as f:
    json.dump(results, f, indent=_sage_const_2)

# Write markdown summary
lines = []
lines.append("# SRG(40,12,2,4) Uniqueness Scan")
lines.append("")
lines.append(f"Generated: {results['timestamp']}")
lines.append("")
lines.append(f"Total graphs enumerated: {results['count']}")
if results["errors"]:
    lines.append("")
    lines.append("## Errors")
    for e in results["errors"]:
        lines.append(f"- {e}")

lines.append("")
lines.append("## Summary Table")
lines.append("")
lines.append(
    "| idx | aut_order | clique_number | max_clique_count | neighbor_graphs_triangle_free | isomorphic_to_w33 |"
)
lines.append("|---:|---:|---:|---:|:---:|:---:|")
for g in results["graphs"]:
    lines.append(
        f"| {g['index']} | {g['aut_order']} | {g['clique_number']} | {g['max_clique_count']} | {g['neighbor_graphs_triangle_free']} | {g['isomorphic_to_w33']} |"
    )

with open(out_md, "w") as f:
    f.write("\n".join(lines) + "\n")

print(f"Wrote {out_json}")
print(f"Wrote {out_md}")
